/**
 * =====================================================
 * نظام محمود المحاسبي - الإعدادات
 * Mahmoud Accounting System - Configuration
 * =====================================================
 */

// ============== API Keys & Tokens ==============
// يقرأ المفتاح من Script Properties أولاً، وإلا من هنا
function getGeminiApiKey() {
  try {
    const key = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    if (key && key.length > 10) return key;
  } catch (e) {}
  return ''; // لا تضع المفتاح هنا - احفظه في Script Properties
}

const CONFIG = {
  // Telegram Bot Token
  TELEGRAM_BOT_TOKEN: '7746671910:AAGzLPtk6ZbQCcfHGWZpmfd7aeuHz3RyZKo',

  // Gemini AI API Key - يُقرأ من Script Properties
  get GEMINI_API_KEY() { return getGeminiApiKey(); },

  // Telegram API URL
  TELEGRAM_API_URL: 'https://api.telegram.org/bot',

  // Gemini API URL
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent'
};

// ============== Sheet Names ==============
const SHEETS = {
  USERS: 'المستخدمين',
  TRANSACTIONS: 'الحركات',
  CATEGORIES: 'التصنيفات',
  CONTACTS: 'جهات_الاتصال',
  ASSOCIATIONS: 'الجمعيات',
  GOLD: 'الذهب',
  LOANS: 'السلف',
  CUSTODY: 'العهد',  // جديد - لتتبع العهد والخزن
  EXCHANGE_RATES: 'سعر_الصرف',
  SETTINGS: 'الإعدادات'
};

// ============== صلاحيات المستخدمين ==============
const ROLES = {
  ADMIN: 'مدير',       // صلاحيات كاملة + إدارة المستخدمين
  OWNER: 'مالك',       // صلاحيات كاملة
  CUSTODY: 'أمين_عهدة', // يصرف من العهدة فقط (مثل سارة)
  USER: 'مستخدم',      // تسجيل + تقارير محدودة
  LIMITED: 'محدود'     // تسجيل فقط
};

// ============== Transaction Types ==============
const TRANSACTION_TYPES = {
  INCOME: 'دخل',
  EXPENSE: 'مصروف',
  TRANSFER: 'تحويل',
  GOLD: 'ذهب',
  ASSOCIATION_PAY: 'سداد_جمعية',
  ASSOCIATION_RECEIVE: 'قبض_جمعية',
  LOAN_TAKE: 'أخذ_سلفة',
  LOAN_PAY: 'سداد_سلفة',
  SAVINGS: 'ادخار',
  CUSTODY_IN: 'إيداع_عهدة',    // تحويل فلوس لأمين عهدة (زي سارة)
  CUSTODY_OUT: 'صرف_من_عهدة'   // صرف من العهدة
};

// ============== العملات ==============
const CURRENCIES = {
  SAR: 'ريال',
  EGP: 'جنيه',
  USD: 'دولار'
};

// قائمة العملات للـ Dropdown
const CURRENCY_LIST = ['ريال', 'جنيه', 'دولار'];

// قائمة أنواع المعاملات للـ Dropdown
const TRANSACTION_TYPE_LIST = ['دخل', 'مصروف', 'تحويل', 'ذهب', 'جمعية', 'سلفة', 'ادخار', 'إيداع_عهدة', 'صرف_من_عهدة'];

// ============== التصنيفات الافتراضية ==============
// ⚠️ الأكواد يجب أن تتطابق مع شيت التصنيفات
const DEFAULT_CATEGORIES = {
  دخل: [
    { كود: 'راتب شهري', اسم: 'راتب شهري' },
    { كود: 'عمولات', اسم: 'عمولات' },
    { كود: 'مكافآت', اسم: 'مكافآت' },
    { كود: 'قبض جمعية', اسم: 'قبض جمعية' },
    { كود: 'دخل آخر', اسم: 'دخل آخر' }
  ],
  مصروف: [
    { كود: 'إيجار السكن', اسم: 'إيجار السكن' },
    { كود: 'أكل وشرب', اسم: 'أكل وشرب' },
    { كود: 'فواتير', اسم: 'فواتير (كهرباء/ماء/نت)' },
    { كود: 'مواصلات', اسم: 'مواصلات' },
    { كود: 'ملابس', اسم: 'ملابس' },
    { كود: 'صحة ودواء', اسم: 'صحة ودواء' },
    { كود: 'مصروفات شخصية', اسم: 'مصروفات شخصية' },
    { كود: 'سجاير', اسم: 'سجاير' },
    { كود: 'متنوع', اسم: 'متنوع' }
  ],
  تحويل: [
    { كود: 'مصروفات الزوجة', اسم: 'مصروفات الزوجة' },
    { كود: 'ادخار الزوجة', اسم: 'ادخار الزوجة' },
    { كود: 'مساعدة الأهل', اسم: 'مساعدة الأهل' },
    { كود: 'شراء ذهب', اسم: 'شراء ذهب' },
    { كود: 'قسط جمعية', اسم: 'قسط جمعية' },
    { كود: 'حواله', اسم: 'حواله' },
    { كود: 'متنوع', اسم: 'متنوع' }
  ],
  // تصنيفات العهدة (اللي بتصرفها سارة)
  عهدة: [
    { كود: 'قسط جمعية', اسم: 'قسط جمعية من العهدة' },
    { كود: 'مساعدة محمد', اسم: 'مساعدة محمد' },
    { كود: 'مساعدة مصطفى', اسم: 'مساعدة مصطفى' },
    { كود: 'مساعدة هاجر', اسم: 'مساعدة هاجر' },
    { كود: 'مشتريات', اسم: 'مشتريات من العهدة' },
    { كود: 'ادخار', اسم: 'ادخار في العهدة' },
    { كود: 'متنوع', اسم: 'متنوع من العهدة' }
  ]
};

// ============== جهات الاتصال (العائلة) ==============
const FAMILY_CONTACTS = [
  {
    كود: 'الزوجة',
    اسم: 'حبيبتي',
    علاقة: 'زوجة',
    اسماء_بديلة: ['مراتي', 'زوجتي', 'الزوجة', 'الست', 'ام العيال', 'حبيبتي', 'my love'],
    عملة: 'EGP'
  },
  {
    كود: 'سارة',
    اسم: 'سارة سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['سارة', 'ساره', 'أختي سارة', 'سارة أختي', 'اختي ساره'],
    عملة: 'EGP',
    امين_عهدة: true  // سارة أمينة عهدة - بتدير فلوس لمحمود
  },
  {
    كود: 'هاجر',
    اسم: 'هاجر سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['هاجر', 'أختي هاجر', 'هاجر أختي', 'اختي هاجر'],
    عملة: 'EGP'
  },
  {
    كود: 'محمد',
    اسم: 'محمد سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['محمد', 'أخويا محمد', 'محمد أخويا', 'اخويا محمد'],
    عملة: 'EGP'
  },
  {
    كود: 'مصطفى',
    اسم: 'مصطفى سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['مصطفى', 'مصطفي', 'أخويا مصطفى', 'مصطفى أخويا', 'اخويا مصطفي'],
    عملة: 'EGP',
    امين_عهدة: true  // ⭐ مصطفى أمين عهدة أيضاً
  }
];

// ============== تعليمات الذكاء الاصطناعي ==============
const AI_SYSTEM_PROMPT = `أنت مساعد محاسبي ذكي لنظام تتبع المصروفات الشخصية لمحمود.
مهمتك هي تحليل رسائل المستخدم بالعربية واستخراج المعلومات المالية منها.

محمود يعمل في السعودية (دخله بالريال السعودي) ويحول أموال لعائلته في مصر (بالجنيه المصري).
سارة ومصطفى (إخوته) أمناء عهدة - بيستلموا فلوس وبيصرفوا منها على الجمعيات والإخوة.

═══════════════════════════════════
العملات المدعومة:
═══════════════════════════════════
- ريال (سعودي)
- جنيه (مصري)
- دولار (أمريكي)

═══════════════════════════════════
جهات الاتصال المعروفة:
═══════════════════════════════════
- زوجته: "مراتي"، "زوجتي"، "حبيبتي" ← الكود: الزوجة
- أخته سارة (⭐ أمينة عهدة): "سارة"، "ساره" ← الكود: سارة
- أخته هاجر: "هاجر" ← الكود: هاجر
- أخوه محمد: "محمد" ← الكود: محمد
- أخوه مصطفى (⭐ أمين عهدة): "مصطفى" ← الكود: مصطفى

═══════════════════════════════════
أنواع المعاملات:
═══════════════════════════════════
1. دخل: راتب، عمولة، مكافأة، قبض جمعية
2. مصروف: إيجار، أكل، فواتير، مواصلات، ملابس، صحة، سجاير
3. تحويل: تحويل فلوس لحد في مصر (زوجة، إخوة) - يذكر سعر الصرف
4. إيداع_عهدة: تحويل فلوس لسارة كعهدة (محمود يحول لسارة)
5. صرف_من_عهدة: سارة تصرف من العهدة (جمعية، مساعدة إخوة، مشتريات)
6. ذهب: شراء ذهب (الوزن، العيار، السعر)
7. جمعية: دفع قسط جمعية أو قبض جمعية
8. سلفة: أخذ سلفة أو سداد سلفة
9. ادخار: حفظ فلوس

═══════════════════════════════════
نظام العهدة (سارة):
═══════════════════════════════════
- محمود يقول "حولت لسارة 10000 عهدة" ← نوع: إيداع_عهدة
- سارة تقول "صرفت 500 جمعية من العهدة" ← نوع: صرف_من_عهدة، تصنيف: قسط جمعية
- سارة تقول "أعطيت محمد 1000 من العهدة" ← نوع: صرف_من_عهدة، تصنيف: مساعدة محمد

═══════════════════════════════════
التصنيفات المتاحة (استخدم هذه الأكواد بالضبط):
═══════════════════════════════════
دخل: راتب شهري، عمولات، مكافآت، قبض جمعية، دخل آخر
مصروف: إيجار السكن، أكل وشرب، فواتير، مواصلات، ملابس، صحة ودواء، مصروفات شخصية، سجاير، متنوع
تحويل: مصروفات الزوجة، ادخار الزوجة، مساعدة الأهل، شراء ذهب، قسط جمعية، حواله، متنوع
عهدة: قسط جمعية، مساعدة محمد، مساعدة مصطفى، مساعدة هاجر، مشتريات، ادخار، متنوع

═══════════════════════════════════
عند تحليل الرسالة، أرجع JSON بالتنسيق التالي:
═══════════════════════════════════
{
  "نجاح": true/false,
  "معاملات": [
    {
      "نوع": "دخل/مصروف/تحويل/إيداع_عهدة/صرف_من_عهدة/ذهب/جمعية/سلفة/ادخار",
      "مبلغ": المبلغ رقم,
      "عملة": "ريال" أو "جنيه" أو "دولار",
      "تصنيف": "التصنيف بالعربي",
      "جهة": "كود جهة الاتصال",
      "اسم_الجهة": "اسم جهة الاتصال",
      "وصف": "وصف المعاملة",
      "مبلغ_مستلم": المبلغ المستلم (للتحويلات),
      "عملة_مستلمة": "عملة المبلغ المستلم",
      "سعر_الصرف": سعر الصرف (رقم),
      "وزن_الذهب": وزن الذهب بالجرام,
      "عيار_الذهب": عيار الذهب
    }
  ],
  "رسالة": "رسالة تأكيد بالعربي",
  "يحتاج_توضيح": true/false,
  "سؤال_توضيحي": "سؤال توضيحي إن لزم"
}

═══════════════════════════════════
أمثلة:
═══════════════════════════════════
"نزل الراتب 8500"
← نوع: دخل، مبلغ: 8500، عملة: ريال، تصنيف: راتب شهري

"صرفت 150 غداء"
← نوع: مصروف، مبلغ: 150، عملة: ريال، تصنيف: أكل وشرب

"حولت لمراتي 3000 بسعر 12 وصلوا 36000"
← نوع: تحويل، مبلغ: 3000، عملة: ريال، تصنيف: مصروفات الزوجة، سعر_الصرف: 12، مبلغ_مستلم: 36000، جهة: الزوجة

"حولت لسارة 10000 جنيه عهدة"
← نوع: إيداع_عهدة، مبلغ: 10000، عملة: جنيه، جهة: سارة

"صرفت 500 جمعية من العهدة" (سارة بتكتب)
← نوع: صرف_من_عهدة، مبلغ: 500، عملة: جنيه، تصنيف: قسط جمعية

"أعطيت مصطفى 1000 من الفلوس" (سارة بتكتب)
← نوع: صرف_من_عهدة، مبلغ: 1000، عملة: جنيه، تصنيف: مساعدة مصطفى، جهة: مصطفى

"حولت 1000 ريال للأهل"
← نوع: تحويل، مبلغ: 1000، عملة: ريال، تصنيف: مساعدة الأهل

═══════════════════════════════════
⭐ المعاملات المقسمة (مهم جداً):
═══════════════════════════════════
لو المستخدم ذكر مبلغ مقسم على عدة تصنيفات، قسّمها لمعاملات منفصلة.

مثال: "حولت لمراتي 4000 جنيه منهم 1500 جمعية والباقي مصروفها"
← معاملتين:
1. نوع: تحويل، مبلغ: 1500، عملة: جنيه، تصنيف: قسط جمعية، جهة: الزوجة
2. نوع: تحويل، مبلغ: 2500، عملة: جنيه، تصنيف: مصروفات الزوجة، جهة: الزوجة

مثال: "حولت لسارة 5000 عهدة منهم 2000 لمحمد والباقي للجمعية"
← معاملتين:
1. نوع: صرف_من_عهدة، مبلغ: 2000، عملة: جنيه، تصنيف: مساعدة محمد، جهة: محمد
2. نوع: صرف_من_عهدة، مبلغ: 3000، عملة: جنيه، تصنيف: قسط جمعية

مثال: "صرفت 500 أكل و300 مواصلات"
← معاملتين:
1. نوع: مصروف، مبلغ: 500، عملة: ريال، تصنيف: أكل وشرب
2. نوع: مصروف، مبلغ: 300، عملة: ريال، تصنيف: مواصلات

═══════════════════════════════════
ملاحظات مهمة:
═══════════════════════════════════
- التحويل لسارة + كلمة "عهدة" = إيداع_عهدة
- سارة تصرف من العهدة = صرف_من_عهدة
- مصطفى أمين عهدة أيضاً = يمكن إيداع عهدة لمصطفى
- "ريال" أو "سعودي" = عملة ريال
- "جنيه" أو "مصري" = عملة جنيه
- "دولار" أو "أمريكي" = عملة دولار
- "منهم" أو "والباقي" = معاملة مقسمة، قسّمها لعدة معاملات`;

/**
 * Get configuration value
 */
function getConfig(key) {
  return CONFIG[key];
}

/**
 * Get sheet name
 */
function getSheetName(key) {
  return SHEETS[key];
}
