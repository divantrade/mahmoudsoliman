/**
 * =====================================================
 * نظام محمود المحاسبي - الإعدادات
 * Mahmoud Accounting System - Configuration
 * =====================================================
 */

// ============== API Keys & Tokens ==============
// يقرأ المفتاح من Script Properties أولاً، وإلا من هنا
function getGeminiApiKey() {
  try {
    const key = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    if (key && key.length > 10) return key;
  } catch (e) {}
  return ''; // لا تضع المفتاح هنا - احفظه في Script Properties
}

const CONFIG = {
  // Telegram Bot Token
  TELEGRAM_BOT_TOKEN: '7746671910:AAGzLPtk6ZbQCcfHGWZpmfd7aeuHz3RyZKo',

  // Gemini AI API Key - يُقرأ من Script Properties
  get GEMINI_API_KEY() { return getGeminiApiKey(); },

  // Telegram API URL
  TELEGRAM_API_URL: 'https://api.telegram.org/bot',

  // Gemini API URL
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent'
};

// ============== Sheet Names ==============
const SHEETS = {
  USERS: 'المستخدمين',
  TRANSACTIONS: 'الحركات',
  CATEGORIES: 'التصنيفات',
  CONTACTS: 'جهات_الاتصال',
  ASSOCIATIONS: 'الجمعيات',
  GOLD: 'الذهب',
  LOANS: 'السلف',
  CUSTODY: 'العهد',  // جديد - لتتبع العهد والخزن
  EXCHANGE_RATES: 'سعر_الصرف',
  SETTINGS: 'الإعدادات'
};

// ============== صلاحيات المستخدمين ==============
const ROLES = {
  ADMIN: 'مدير',       // صلاحيات كاملة + إدارة المستخدمين
  OWNER: 'مالك',       // صلاحيات كاملة
  CUSTODY: 'أمين_عهدة', // يصرف من العهدة فقط (مثل سارة)
  USER: 'مستخدم',      // تسجيل + تقارير محدودة
  LIMITED: 'محدود'     // تسجيل فقط
};

// ============== Transaction Types ==============
const TRANSACTION_TYPES = {
  INCOME: 'دخل',
  EXPENSE: 'مصروف',
  TRANSFER: 'تحويل',
  GOLD: 'ذهب',
  ASSOCIATION_PAY: 'سداد_جمعية',
  ASSOCIATION_RECEIVE: 'قبض_جمعية',
  LOAN_TAKE: 'أخذ_سلفة',
  LOAN_PAY: 'سداد_سلفة',
  SAVINGS: 'ادخار',
  CUSTODY_IN: 'إيداع_عهدة',    // تحويل فلوس لأمين عهدة (زي سارة)
  CUSTODY_OUT: 'صرف_من_عهدة'   // صرف من العهدة
};

// ============== العملات ==============
const CURRENCIES = {
  SAR: 'ريال',
  EGP: 'جنيه',
  USD: 'دولار'
};

// قائمة العملات للـ Dropdown
const CURRENCY_LIST = ['ريال', 'جنيه', 'دولار'];

// قائمة أنواع المعاملات للـ Dropdown
const TRANSACTION_TYPE_LIST = ['دخل', 'مصروف', 'تحويل', 'ذهب', 'جمعية', 'سلفة', 'ادخار', 'إيداع_عهدة', 'صرف_من_عهدة'];

// ============== التصنيفات الافتراضية ==============
const DEFAULT_CATEGORIES = {
  دخل: [
    { كود: 'راتب', اسم: 'راتب شهري' },
    { كود: 'عمولة', اسم: 'عمولات' },
    { كود: 'مكافأة', اسم: 'مكافآت' },
    { كود: 'قبض_جمعية', اسم: 'قبض جمعية' },
    { كود: 'دخل_آخر', اسم: 'دخل آخر' }
  ],
  مصروف_سعودي: [
    { كود: 'إيجار', اسم: 'إيجار السكن' },
    { كود: 'أكل', اسم: 'أكل وشرب' },
    { كود: 'فواتير', اسم: 'فواتير (كهرباء/ماء/نت)' },
    { كود: 'مواصلات', اسم: 'مواصلات' },
    { كود: 'ملابس', اسم: 'ملابس' },
    { كود: 'صحة', اسم: 'صحة ودواء' },
    { كود: 'شخصي', اسم: 'مصروفات شخصية' },
    { كود: 'سجاير', اسم: 'سجاير' },
    { كود: 'متنوع', اسم: 'متنوع' }
  ],
  مصروف_مصر: [
    { كود: 'مصروف_الزوجة', اسم: 'مصروفات الزوجة' },
    { كود: 'ادخار_الزوجة', اسم: 'ادخار الزوجة' },
    { كود: 'مساعدة_أهل', اسم: 'مساعدة الأهل' },
    { كود: 'ذهب', اسم: 'شراء ذهب' },
    { كود: 'جمعية', اسم: 'قسط جمعية' },
    { كود: 'متنوع_مصر', اسم: 'متنوع' }
  ],
  // تصنيفات العهدة (اللي بتصرفها سارة)
  عهدة: [
    { كود: 'جمعية_عهدة', اسم: 'قسط جمعية من العهدة' },
    { كود: 'مساعدة_محمد', اسم: 'مساعدة محمد' },
    { كود: 'مساعدة_مصطفى', اسم: 'مساعدة مصطفى' },
    { كود: 'مساعدة_هاجر', اسم: 'مساعدة هاجر' },
    { كود: 'مشتريات_عهدة', اسم: 'مشتريات من العهدة' },
    { كود: 'ادخار_عهدة', اسم: 'ادخار في العهدة' },
    { كود: 'متنوع_عهدة', اسم: 'متنوع من العهدة' }
  ]
};

// ============== جهات الاتصال (العائلة) ==============
const FAMILY_CONTACTS = [
  {
    كود: 'الزوجة',
    اسم: 'حبيبتي',
    علاقة: 'زوجة',
    اسماء_بديلة: ['مراتي', 'زوجتي', 'الزوجة', 'الست', 'ام العيال', 'حبيبتي', 'my love'],
    عملة: 'EGP'
  },
  {
    كود: 'سارة',
    اسم: 'سارة سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['سارة', 'ساره', 'أختي سارة', 'سارة أختي', 'اختي ساره'],
    عملة: 'EGP',
    امين_عهدة: true  // سارة أمينة عهدة - بتدير فلوس لمحمود
  },
  {
    كود: 'هاجر',
    اسم: 'هاجر سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['هاجر', 'أختي هاجر', 'هاجر أختي', 'اختي هاجر'],
    عملة: 'EGP'
  },
  {
    كود: 'محمد',
    اسم: 'محمد سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['محمد', 'أخويا محمد', 'محمد أخويا', 'اخويا محمد'],
    عملة: 'EGP'
  },
  {
    كود: 'مصطفى',
    اسم: 'مصطفى سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['مصطفى', 'مصطفي', 'أخويا مصطفى', 'مصطفى أخويا', 'اخويا مصطفي'],
    عملة: 'EGP'
  }
];

// ============== تعليمات الذكاء الاصطناعي ==============
const AI_SYSTEM_PROMPT = `أنت مساعد محاسبي ذكي لنظام تتبع المصروفات الشخصية لمحمود.
مهمتك هي تحليل رسائل المستخدم بالعربية واستخراج المعلومات المالية منها.

محمود يعمل في السعودية (دخله بالريال السعودي) ويحول أموال لعائلته في مصر (بالجنيه المصري).
سارة (أخته) هي أمينة عهدة - بتستلم فلوس وتصرف منها على الجمعيات والإخوة.

═══════════════════════════════════
العملات المدعومة:
═══════════════════════════════════
- ريال (سعودي)
- جنيه (مصري)
- دولار (أمريكي)

═══════════════════════════════════
جهات الاتصال المعروفة:
═══════════════════════════════════
- زوجته: "مراتي"، "زوجتي"، "حبيبتي" ← الكود: الزوجة
- أخته سارة (أمينة العهدة): "سارة"، "ساره" ← الكود: سارة
- أخته هاجر: "هاجر" ← الكود: هاجر
- أخوه محمد: "محمد" ← الكود: محمد
- أخوه مصطفى: "مصطفى" ← الكود: مصطفى

═══════════════════════════════════
أنواع المعاملات:
═══════════════════════════════════
1. دخل: راتب، عمولة، مكافأة، قبض جمعية
2. مصروف: إيجار، أكل، فواتير، مواصلات، ملابس، صحة، سجاير
3. تحويل: تحويل فلوس لحد في مصر (زوجة، إخوة) - يذكر سعر الصرف
4. إيداع_عهدة: تحويل فلوس لسارة كعهدة (محمود يحول لسارة)
5. صرف_من_عهدة: سارة تصرف من العهدة (جمعية، مساعدة إخوة، مشتريات)
6. ذهب: شراء ذهب (الوزن، العيار، السعر)
7. جمعية: دفع قسط جمعية أو قبض جمعية
8. سلفة: أخذ سلفة أو سداد سلفة
9. ادخار: حفظ فلوس

═══════════════════════════════════
نظام العهدة (سارة):
═══════════════════════════════════
- محمود يقول "حولت لسارة 10000 عهدة" ← نوع: إيداع_عهدة
- سارة تقول "صرفت 500 جمعية من العهدة" ← نوع: صرف_من_عهدة
- سارة تقول "أعطيت محمد 1000 من العهدة" ← نوع: صرف_من_عهدة، تصنيف: مساعدة_محمد

═══════════════════════════════════
التصنيفات المتاحة:
═══════════════════════════════════
دخل: راتب، عمولة، مكافأة، قبض_جمعية، دخل_آخر
مصروف سعودي: إيجار، أكل، فواتير، مواصلات، ملابس، صحة، شخصي، سجاير، متنوع
مصروف مصر: مصروف_الزوجة، ادخار_الزوجة، مساعدة_أهل، ذهب، جمعية، متنوع_مصر
عهدة: جمعية_عهدة، مساعدة_محمد، مساعدة_مصطفى، مساعدة_هاجر، مشتريات_عهدة، ادخار_عهدة، متنوع_عهدة

═══════════════════════════════════
عند تحليل الرسالة، أرجع JSON بالتنسيق التالي:
═══════════════════════════════════
{
  "نجاح": true/false,
  "معاملات": [
    {
      "نوع": "دخل/مصروف/تحويل/إيداع_عهدة/صرف_من_عهدة/ذهب/جمعية/سلفة/ادخار",
      "مبلغ": المبلغ رقم,
      "عملة": "ريال" أو "جنيه" أو "دولار",
      "تصنيف": "التصنيف بالعربي",
      "جهة": "كود جهة الاتصال",
      "اسم_الجهة": "اسم جهة الاتصال",
      "وصف": "وصف المعاملة",
      "مبلغ_مستلم": المبلغ المستلم (للتحويلات),
      "عملة_مستلمة": "عملة المبلغ المستلم",
      "سعر_الصرف": سعر الصرف (رقم),
      "وزن_الذهب": وزن الذهب بالجرام,
      "عيار_الذهب": عيار الذهب
    }
  ],
  "رسالة": "رسالة تأكيد بالعربي",
  "يحتاج_توضيح": true/false,
  "سؤال_توضيحي": "سؤال توضيحي إن لزم"
}

═══════════════════════════════════
أمثلة:
═══════════════════════════════════
"حولت لسارة 10000 جنيه عهدة"
← نوع: إيداع_عهدة، مبلغ: 10000، عملة: جنيه، جهة: سارة

"صرفت 500 جمعية من العهدة" (سارة بتكتب)
← نوع: صرف_من_عهدة، مبلغ: 500، عملة: جنيه، تصنيف: جمعية_عهدة

"أعطيت مصطفى 1000 من الفلوس" (سارة بتكتب)
← نوع: صرف_من_عهدة، مبلغ: 1000، عملة: جنيه، تصنيف: مساعدة_مصطفى، جهة: مصطفى

"حولت 1000 ريال بسعر 13.5 وصلوا 13500 لمراتي"
← نوع: تحويل، مبلغ: 1000، عملة: ريال، سعر_الصرف: 13.5، مبلغ_مستلم: 13500

═══════════════════════════════════
ملاحظات مهمة:
═══════════════════════════════════
- التحويل لسارة + كلمة "عهدة" = إيداع_عهدة
- سارة تصرف من العهدة = صرف_من_عهدة
- "ريال" أو "سعودي" = عملة ريال
- "جنيه" أو "مصري" = عملة جنيه
- "دولار" أو "أمريكي" = عملة دولار`;

/**
 * Get configuration value
 */
function getConfig(key) {
  return CONFIG[key];
}

/**
 * Get sheet name
 */
function getSheetName(key) {
  return SHEETS[key];
}
