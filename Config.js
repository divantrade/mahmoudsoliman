/**
 * =====================================================
 * نظام محمود المحاسبي - الإعدادات
 * Mahmoud Accounting System - Configuration
 * =====================================================
 */

// ============== API Keys & Tokens ==============
// يقرأ المفتاح من Script Properties أولاً، وإلا من هنا
function getGeminiApiKey() {
  try {
    const key = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
    if (key && key.length > 10) return key;
  } catch (e) {}
  return ''; // لا تضع المفتاح هنا - احفظه في Script Properties
}

const CONFIG = {
  // Telegram Bot Token
  TELEGRAM_BOT_TOKEN: '7746671910:AAGzLPtk6ZbQCcfHGWZpmfd7aeuHz3RyZKo',

  // Gemini AI API Key - يُقرأ من Script Properties
  get GEMINI_API_KEY() { return getGeminiApiKey(); },

  // Telegram API URL
  TELEGRAM_API_URL: 'https://api.telegram.org/bot',

  // Gemini API URL
  GEMINI_API_URL: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent'
};

// ============== Sheet Names ==============
const SHEETS = {
  USERS: 'المستخدمين',
  TRANSACTIONS: 'الحركات',
  CATEGORIES: 'التصنيفات',
  CONTACTS: 'جهات_الاتصال',
  ASSOCIATIONS: 'الجمعيات',
  GOLD: 'الذهب',
  LOANS: 'السلف',
  EXCHANGE_RATES: 'سعر_الصرف',
  SETTINGS: 'الإعدادات'
};

// ============== صلاحيات المستخدمين ==============
const ROLES = {
  ADMIN: 'مدير',       // صلاحيات كاملة + إدارة المستخدمين
  OWNER: 'مالك',       // صلاحيات كاملة
  USER: 'مستخدم',      // تسجيل + تقارير محدودة
  LIMITED: 'محدود'     // تسجيل فقط
};

// ============== Transaction Types ==============
const TRANSACTION_TYPES = {
  INCOME: 'دخل',
  EXPENSE: 'مصروف',
  TRANSFER: 'تحويل',
  GOLD: 'ذهب',
  ASSOCIATION_PAY: 'سداد_جمعية',
  ASSOCIATION_RECEIVE: 'قبض_جمعية',
  LOAN_TAKE: 'أخذ_سلفة',
  LOAN_PAY: 'سداد_سلفة',
  SAVINGS: 'ادخار'
};

// ============== العملات ==============
const CURRENCIES = {
  SAR: 'ريال',
  EGP: 'جنيه',
  USD: 'دولار'
};

// قائمة العملات للـ Dropdown
const CURRENCY_LIST = ['ريال', 'جنيه', 'دولار'];

// قائمة أنواع المعاملات للـ Dropdown
const TRANSACTION_TYPE_LIST = ['دخل', 'مصروف', 'تحويل', 'ذهب', 'جمعية', 'سلفة', 'ادخار'];

// ============== التصنيفات الافتراضية ==============
const DEFAULT_CATEGORIES = {
  دخل: [
    { كود: 'راتب', اسم: 'راتب شهري' },
    { كود: 'عمولة', اسم: 'عمولات' },
    { كود: 'مكافأة', اسم: 'مكافآت' },
    { كود: 'قبض_جمعية', اسم: 'قبض جمعية' },
    { كود: 'دخل_آخر', اسم: 'دخل آخر' }
  ],
  مصروف_سعودي: [
    { كود: 'إيجار', اسم: 'إيجار السكن' },
    { كود: 'أكل', اسم: 'أكل وشرب' },
    { كود: 'فواتير', اسم: 'فواتير (كهرباء/ماء/نت)' },
    { كود: 'مواصلات', اسم: 'مواصلات' },
    { كود: 'ملابس', اسم: 'ملابس' },
    { كود: 'صحة', اسم: 'صحة ودواء' },
    { كود: 'شخصي', اسم: 'مصروفات شخصية' },
    { كود: 'سجاير', اسم: 'سجاير' },
    { كود: 'متنوع', اسم: 'متنوع' }
  ],
  مصروف_مصر: [
    { كود: 'مصروف_الزوجة', اسم: 'مصروفات الزوجة' },
    { كود: 'ادخار_الزوجة', اسم: 'ادخار الزوجة' },
    { كود: 'مساعدة_أهل', اسم: 'مساعدة الأهل' },
    { كود: 'ذهب', اسم: 'شراء ذهب' },
    { كود: 'جمعية', اسم: 'قسط جمعية' },
    { كود: 'متنوع_مصر', اسم: 'متنوع' }
  ]
};

// ============== جهات الاتصال (العائلة) ==============
const FAMILY_CONTACTS = [
  {
    كود: 'الزوجة',
    اسم: 'حبيبتي',
    علاقة: 'زوجة',
    اسماء_بديلة: ['مراتي', 'زوجتي', 'الزوجة', 'الست', 'ام العيال', 'حبيبتي', 'my love'],
    عملة: 'EGP'
  },
  {
    كود: 'سارة',
    اسم: 'سارة سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['سارة', 'ساره', 'أختي سارة', 'سارة أختي', 'اختي ساره'],
    عملة: 'EGP'
  },
  {
    كود: 'هاجر',
    اسم: 'هاجر سليمان',
    علاقة: 'أخت',
    اسماء_بديلة: ['هاجر', 'أختي هاجر', 'هاجر أختي', 'اختي هاجر'],
    عملة: 'EGP'
  },
  {
    كود: 'محمد',
    اسم: 'محمد سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['محمد', 'أخويا محمد', 'محمد أخويا', 'اخويا محمد'],
    عملة: 'EGP'
  },
  {
    كود: 'مصطفى',
    اسم: 'مصطفى سليمان',
    علاقة: 'أخ',
    اسماء_بديلة: ['مصطفى', 'مصطفي', 'أخويا مصطفى', 'مصطفى أخويا', 'اخويا مصطفي'],
    عملة: 'EGP'
  }
];

// ============== تعليمات الذكاء الاصطناعي ==============
const AI_SYSTEM_PROMPT = `أنت مساعد محاسبي ذكي لنظام تتبع المصروفات الشخصية لمحمود.
مهمتك هي تحليل رسائل المستخدم بالعربية واستخراج المعلومات المالية منها.

محمود يعمل في السعودية (دخله بالريال السعودي) ويحول أموال لعائلته في مصر (بالجنيه المصري).

═══════════════════════════════════
العملات المدعومة:
═══════════════════════════════════
- ريال (سعودي)
- جنيه (مصري)
- دولار (أمريكي)

═══════════════════════════════════
جهات الاتصال المعروفة:
═══════════════════════════════════
- زوجته: "مراتي"، "زوجتي"، "حبيبتي"، "الست"، "ام العيال" ← الكود: الزوجة
- أخته سارة: "سارة"، "ساره"، "أختي سارة" ← الكود: سارة
- أخته هاجر: "هاجر"، "أختي هاجر" ← الكود: هاجر
- أخوه محمد: "محمد"، "أخويا محمد" ← الكود: محمد
- أخوه مصطفى: "مصطفى"، "مصطفي"، "أخويا مصطفى" ← الكود: مصطفى

═══════════════════════════════════
أنواع المعاملات:
═══════════════════════════════════
1. دخل: راتب، عمولة، مكافأة، قبض جمعية، دخل آخر
2. مصروف: إيجار، أكل، فواتير، مواصلات، ملابس، صحة، سجاير، شخصي
3. تحويل: تحويل فلوس لحد في مصر (زوجة، أخوات، إخوة) - مهم جداً يذكر سعر الصرف
4. ذهب: شراء ذهب (الوزن بالجرام، العيار، السعر)
5. جمعية: دفع قسط جمعية أو قبض جمعية
6. سلفة: أخذ سلفة من حد أو رد سلفة
7. ادخار: حفظ فلوس

═══════════════════════════════════
التصنيفات المتاحة:
═══════════════════════════════════
دخل: راتب، عمولة، مكافأة، قبض_جمعية، دخل_آخر
مصروف سعودي: إيجار، أكل، فواتير، مواصلات، ملابس، صحة، شخصي، سجاير، متنوع
مصروف مصر: مصروف_الزوجة، ادخار_الزوجة، مساعدة_أهل، ذهب، جمعية، متنوع_مصر

═══════════════════════════════════
عند تحليل الرسالة، أرجع JSON بالتنسيق التالي:
═══════════════════════════════════
{
  "نجاح": true/false,
  "معاملات": [
    {
      "نوع": "دخل/مصروف/تحويل/ذهب/جمعية/سلفة/ادخار",
      "مبلغ": المبلغ رقم,
      "عملة": "ريال" أو "جنيه" أو "دولار",
      "تصنيف": "التصنيف بالعربي",
      "جهة": "كود جهة الاتصال بالعربي إن وجد",
      "اسم_الجهة": "اسم جهة الاتصال",
      "وصف": "وصف المعاملة",
      "مبلغ_مستلم": المبلغ المستلم (للتحويلات - رقم فقط),
      "عملة_مستلمة": "عملة المبلغ المستلم",
      "سعر_الصرف": سعر الصرف (رقم - كم جنيه/دولار لكل ريال),
      "وزن_الذهب": وزن الذهب بالجرام,
      "عيار_الذهب": عيار الذهب
    }
  ],
  "رسالة": "رسالة تأكيد للمستخدم بالعربي",
  "يحتاج_توضيح": true/false,
  "سؤال_توضيحي": "سؤال توضيحي إن لزم"
}

═══════════════════════════════════
أمثلة على التحويلات مع سعر الصرف:
═══════════════════════════════════
"حولت 1000 ريال بسعر 13.5 وصلوا 13500 جنيه لمراتي"
← مبلغ: 1000، عملة: ريال، سعر_الصرف: 13.5، مبلغ_مستلم: 13500، عملة_مستلمة: جنيه

"حولت 500 ريال السعر 13 وصلت سارة 6500"
← مبلغ: 500، عملة: ريال، سعر_الصرف: 13، مبلغ_مستلم: 6500، عملة_مستلمة: جنيه

"بعت 100 دولار بـ 50 جنيه"
← مبلغ: 100، عملة: دولار، سعر_الصرف: 50، مبلغ_مستلم: 5000، عملة_مستلمة: جنيه

═══════════════════════════════════
ملاحظات مهمة:
═══════════════════════════════════
- "ريال" أو "سعودي" = عملة ريال
- "جنيه" أو "مصري" = عملة جنيه
- "دولار" أو "أمريكي" = عملة دولار
- التحويلات: استخرج سعر الصرف من الرسالة (مثل "بسعر 13" أو "السعر 13.5")
- إذا ذكر المبلغ المرسل والمستلم بدون سعر الصرف، احسبه: سعر_الصرف = مبلغ_مستلم / مبلغ
- "دفعت جمعية" = سداد قسط، "قبضت جمعية" = استلام
- "سلفة من محمد" = أخذ سلفة، "رجعت لمحمد" = سداد سلفة
- إذا لم يذكر العملة: المصروف في السعودية = ريال، التحويل لمصر = جنيه`;

/**
 * Get configuration value
 */
function getConfig(key) {
  return CONFIG[key];
}

/**
 * Get sheet name
 */
function getSheetName(key) {
  return SHEETS[key];
}
