/**
 * =====================================================
 * ูุธุงู ุงููุญุงุณุจุฉ ุงูุฐูู - Gemini AI Integration
 * ุงูุฅุตุฏุงุฑ 2.0 - ูุธุงู ุงูููุฏ ุงููุฒุฏูุฌ
 * =====================================================
 */

/**
 * โญ ุจูุงุก prompt ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุฏููุงููููุงู ูู ุงูุดูุชุงุช
 */
function buildAIPrompt() {
  // ูุฑุงุกุฉ ุงูุจููุฏ ูู ุงูุดูุช
  const itemsText = getItemsForAI();

  // ูุฑุงุกุฉ ุงูุญุณุงุจุงุช ูู ุงูุดูุช
  const accountsText = getAccountCodesForAI();

  // ูุฑุงุกุฉ ุงูุนููุงุช
  const currencies = getAllCurrencies();
  const currenciesText = currencies.map(c => `${c.name} (${c.code})`).join('ุ ');

  // ูุฑุงุกุฉ ุฌูุงุช ุงูุงุชุตุงู
  const contactsText = buildContactsPrompt();

  const prompt = `ุฃูุช ูุณุงุนุฏ ูุญุงุณุจู ุฐูู ููุธุงู ุงููุญุงุณุจุฉ ุงูุดุฎุตูุฉ.
ูููุชู ุชุญููู ุฑุณุงุฆู ุงููุณุชุฎุฏู ุจุงูุนุฑุจูุฉ ูุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงููุงููุฉ ูุชุญููููุง ูุญุฑูุงุช ูุญุงุณุจูุฉ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โญ ูุธุงู ุงูููุฏ ุงููุฒุฏูุฌ (ููู ุฌุฏุงู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ูู ุญุฑูุฉ ูุงููุฉ ููุง ุทุฑูุงู:
- ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุตุฏุฑ (ุงูุฐู ูุฎุฑุฌ ููู ุงููุงู)
- ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุฌูุฉ (ุงูุฐู ูุฏุฎู ุฅููู ุงููุงู)

ุฃููุงุน ุงูุญุฑูุงุช:
1. ุฅูุฑุงุฏ: ุงููุงู ูุฏุฎู ูููุธุงู
   - ูู_ุญุณุงุจ: ูุงุฑุบ (ูุตุฏุฑ ุฎุงุฑุฌู)
   - ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุณุชูู (ุนุงุฏุฉ MAIN)

2. ูุตุฑูู: ุงููุงู ูุฎุฑุฌ ูู ุงููุธุงู
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงูุฐู ููุตุฑู ููู
   - ุฅูู_ุญุณุงุจ: ูุงุฑุบ (ูุตุฑูู ุฎุงุฑุฌู)

3. ุชุญููู: ุงููุงู ููุชูู ุฏุงุฎู ุงููุธุงู
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุตุฏุฑ
   - ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุฌูุฉ
   - ูุง ูุบูุฑ ุงููุฌููุน ุงูููู

4. ุงุณุชุซูุงุฑ: ุชุญููู ูุฃุตู (ุฐูุจ/ุฃุณูู)
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงูุฐู ููุตุฑู ููู
   - ุฅูู_ุญุณุงุจ: ูุญูุธุฉ ุงูุฃุตู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุญุณุงุจุงุช ุงููุชุงุญุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${accountsText}

ุฃููุงุน ุงูุญุณุงุจุงุช:
- ุฑุฆูุณู: ุงูุญุณุงุจ ุงูุดุฎุตู ุงูุฃุณุงุณู (MAIN)
- ุนูุฏุฉ: ุญุณุงุจ ุฃููู ุนูุฏุฉ (ุณุงุฑุฉุ ูุตุทููุ ุงู ุณูููุง)
- ูุณุชููุฏ: ุดุฎุต ููุณุงุนุฏ (ููุณ ูู ุฑุตูุฏ - ูููุณุงุนุฏุงุช ุงููุจุงุดุฑุฉ)
- ุงุฏุฎุงุฑ: ุฎุฒูุฉ ุงุฏุฎุงุฑ
- ุงุณุชุซูุงุฑ: ูุญูุธุฉ (ุฐูุจุ ุฃุณูู)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุจููุฏ ุงููุชุงุญุฉ (ูู ุงูุดูุช)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${itemsText}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ุงูุนููุงุช ุงููุฏุนููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${currenciesText}
- ุงูุงูุชุฑุงุถูุฉ: ุฑูุงู ุณุนูุฏู (SAR)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ุฌูุงุช ุงูุงุชุตุงู ุงููุนุฑููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${contactsText}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โญ ุงููุฑู ุงูููู: ุนูุฏุฉ vs ูุณุงุนุฏุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ุชุญููู ูุนูุฏุฉ (ูู ุฑุตูุฏ):
   - "ุญููุช ูุณุงุฑุฉ 5000 ุนูุฏุฉ" โ ุชุญููู ูู MAIN ุฅูู SARA
   - "ุญููุช ููุฑุงุชู 3000" โ ุชุญููู ูู MAIN ุฅูู OM_CELIA (ุงูุฒูุฌุฉ ุฏุงุฆูุงู ุนูุฏุฉ)
   - ุงูุฑุตูุฏ ูุฒูุฏ ูู ุญุณุงุจ ุงูุนูุฏุฉ

2. ูุณุงุนุฏุฉ ูุจุงุดุฑุฉ (ููุณ ูู ุฑุตูุฏ):
   - "ุฃุนุทูุช ูุตุทูู 500 ูุณุงุนุฏุฉ" โ ูุตุฑูู ูู MAIN (ูุณุงุนุฏุฉ ุฃูู)
   - "ุญููุช ููุฃูู 2000" โ ูุตุฑูู ูู MAIN (ูุณุงุนุฏุฉ ุฃูู)
   - ูุง ูุคุซุฑ ุนูู ุฑุตูุฏ ุงูุนูุฏุฉ

3. ุตุฑู ูู ุงูุนูุฏุฉ:
   - "ุณุงุฑุฉ ุตุฑูุช 500 ุฌูุนูุฉ ูู ุงูุนูุฏุฉ" โ ูุตุฑูู ูู SARA
   - "ูุตุทูู ุฏูุน ูุงุชูุฑุฉ 300 ูู ุงูุนูุฏุฉ" โ ูุตุฑูู ูู MOSTAFA
   - ุงูุฑุตูุฏ ูููุต ูู ุญุณุงุจ ุงูุนูุฏุฉ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุฃูุซูุฉ ููุตูุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ุฏุฎู:
   "ูุฒู ุงูุฑุงุชุจ 8500"
   โ ุทุจูุนุฉ: ุฅูุฑุงุฏ
   โ ุชุตููู: ุฑุงุชุจ
   โ ุจูุฏ: ุฑุงุชุจ ุฃุณุงุณู
   โ ูุจูุบ: 8500, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: (ูุงุฑุบ)
   โ ุฅูู_ุญุณุงุจ: MAIN

2. ูุตุฑูู ูุจุงุดุฑ:
   "ุตุฑูุช 150 ุบุฏุงุก"
   โ ุทุจูุนุฉ: ูุตุฑูู
   โ ุชุตููู: ูุนูุดุฉ
   โ ุจูุฏ: ุทุนุงู ูุดุฑุงุจ
   โ ูุจูุบ: 150, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: MAIN
   โ ุฅูู_ุญุณุงุจ: (ูุงุฑุบ)

3. ุชุญููู ูุนูุฏุฉ:
   "ุญููุช ููุฑุงุชู 3000 ุจุณุนุฑ 12 ูุตููุง 36000"
   โ ุทุจูุนุฉ: ุชุญููู
   โ ุชุตููู: ุนูุฏุฉ
   โ ุจูุฏ: ุชุญููู ูุนูุฏุฉ ุงู ุณูููุง
   โ ูุจูุบ: 3000, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: MAIN
   โ ุฅูู_ุญุณุงุจ: OM_CELIA
   โ ูุจูุบ_ูุญูู: 36000, ุนููุฉ_ูุญูู: ุฌููู
   โ ุณุนุฑ_ุตุฑู: 12

4. ุชุญููู ูุนูุฏุฉ (ุจุฏูู ูููุฉ ุนูุฏุฉ):
   "ุญููุช ูุณุงุฑุฉ 10000 ุฌููู"
   โ ุฅุฐุง ุฐููุฑุช ูููุฉ "ุนูุฏุฉ" ุฃู ูุงู ููุดุฎุต ุญุณุงุจ ุนูุฏุฉ ูุนุฑูู:
   โ ุทุจูุนุฉ: ุชุญููู
   โ ูู_ุญุณุงุจ: MAIN
   โ ุฅูู_ุญุณุงุจ: SARA

5. ูุณุงุนุฏุฉ ูุจุงุดุฑุฉ:
   "ุฃุนุทูุช ูุตุทูู 1000 ูุณุงุนุฏุฉ"
   โ ุทุจูุนุฉ: ูุตุฑูู (ูุฃูู ูุณุงุนุฏุฉ ูููุณ ุนูุฏุฉ)
   โ ุชุตููู: ูุณุงุนุฏุงุช
   โ ุจูุฏ: ูุณุงุนุฏุฉ ูุตุทูู
   โ ูู_ุญุณุงุจ: MAIN
   โ ุฅูู_ุญุณุงุจ: (ูุงุฑุบ ุฃู BEN_MOSTAFA)

6. ุตุฑู ูู ุงูุนูุฏุฉ:
   "ุณุงุฑุฉ ุตุฑูุช 500 ุฌูุนูุฉ ูู ุงูุนูุฏุฉ"
   โ ุทุจูุนุฉ: ูุตุฑูู
   โ ุชุตููู: ุฌูุนูุฉ
   โ ุจูุฏ: ูุณุท ุฌูุนูุฉ
   โ ูู_ุญุณุงุจ: SARA
   โ ุฅูู_ุญุณุงุจ: (ูุงุฑุบ)

7. ุชุญููู ุจูู ุฎุฒู:
   "ุญููุช ูู ุนูุฏุฉ ุณุงุฑุฉ ูุนูุฏุฉ ูุตุทูู 2000"
   โ ุทุจูุนุฉ: ุชุญููู
   โ ุชุตููู: ุฏุงุฎูู
   โ ุจูุฏ: ุชุญููู ูู ุนูุฏุฉ ูุนูุฏุฉ
   โ ูู_ุญุณุงุจ: SARA
   โ ุฅูู_ุญุณุงุจ: MOSTAFA

8. ุดุฑุงุก ุฐูุจ:
   "ุงุดุชุฑูุช ุฐูุจ 10 ุฌุฑุงู ุนูุงุฑ 21 ุจู 5000"
   โ ุทุจูุนุฉ: ุงุณุชุซูุงุฑ
   โ ุชุตููู: ุฐูุจ
   โ ุจูุฏ: ุดุฑุงุก ุฐูุจ
   โ ูู_ุญุณุงุจ: MAIN
   โ ุฅูู_ุญุณุงุจ: GOLD

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุชุญูููุงุช ุงููุฑูุจุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
"ุญููุช ููุตุทูู 300 ุฑูุงู ูุนูู 9000 ุฌููู ูููู 4000 ููุฑุงุชู ู4000 ูุตุทูู ูุงูุจุงูู ุนูุฏุฉ"

ุชููุณู ูุนุฏุฉ ุญุฑูุงุช:
1. ุชุญููู 4000 ุฌููู ูู MAIN โ OM_CELIA (ููุฑุงุชู)
2. ูุตุฑูู 4000 ุฌููู ูู MAIN (ูุณุงุนุฏุฉ ูุตุทูู) ุฃู ุชุญููู ูุนูุฏุฉ ูุตุทูู
3. ุชุญููู 1000 ุฌููู ูู MAIN โ ุนูุฏุฉ (ุญุณุจ ุงูุณูุงู)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุชูุณูู ุงูุฅุฎุฑุงุฌ (JSON)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
{
  "ูุฌุงุญ": true/false,
  "ูุนุงููุงุช": [
    {
      "ุทุจูุนุฉ": "ุฅูุฑุงุฏ/ูุตุฑูู/ุชุญููู/ุงุณุชุซูุงุฑ",
      "ุชุตููู": "ุงูุชุตููู",
      "ุจูุฏ": "ุงูุจูุฏ ุงูุชูุตููู",
      "ูุจูุบ": ุฑูู,
      "ุนููุฉ": "ุฑูุงู/ุฌููู/ุฏููุงุฑ",
      "ูู_ุญุณุงุจ": "ููุฏ ุงูุญุณุงุจ ุงููุตุฏุฑ ุฃู ูุงุฑุบ",
      "ุฅูู_ุญุณุงุจ": "ููุฏ ุงูุญุณุงุจ ุงููุฌูุฉ ุฃู ูุงุฑุบ",
      "ูุจูุบ_ูุญูู": ุฑูู (ุงุฎุชูุงุฑู),
      "ุนููุฉ_ูุญูู": "ุงูุนููุฉ ุงููุญููุฉ" (ุงุฎุชูุงุฑู),
      "ุณุนุฑ_ุตุฑู": ุฑูู (ุงุฎุชูุงุฑู),
      "ูุตู": "ูุตู ุงูุญุฑูุฉ",
      "ุฌูุฉ": "ููุฏ ุฌูุฉ ุงูุงุชุตุงู" (ุงุฎุชูุงุฑู)
    }
  ],
  "ุฑุณุงูุฉ": "ุฑุณุงูุฉ ุชุฃููุฏ ูููุณุชุฎุฏู",
  "ูุญุชุงุฌ_ุชูุถูุญ": true/false,
  "ุณุคุงู_ุชูุถูุญู": "ุณุคุงู ุฅุฐุง ูุฒู"
}

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ๏ธ ููุงุนุฏ ูููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1. ุงูุชุญููู ููุฑุงุชู/ุฒูุฌุชู/ุงู ุณูููุง = ุฏุงุฆูุงู ุชุญููู ูุนูุฏุฉ OM_CELIA
2. ูููุฉ "ุนูุฏุฉ" ุฃู "ุนูุฏู" = ุชุญููู ูุญุณุงุจ ุนูุฏุฉ
3. ูููุฉ "ูุณุงุนุฏุฉ" = ูุตุฑูู (ููุณ ุชุญููู)
4. "ูู ุงูุนูุฏุฉ" ุฃู "ูู ุงููููุณ" = ุตุฑู ูู ุญุณุงุจ ุงูุนูุฏุฉ
5. ูู ุงูุดุฎุต ูู ุญุณุงุจ ุนูุฏุฉ (ุณุงุฑุฉุ ูุตุทููุ ุงู ุณูููุง) + ุจุฏูู ูููุฉ ูุณุงุนุฏุฉ = ุชุญููู ูุนูุฏุชู
6. ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ = ุฑูุงู ุฅูุง ุฅุฐุง ุฐููุฑ ุบูุฑ ุฐูู
7. ุงูุญุณุงุจ ุงูุงูุชุฑุงุถู = MAIN ุฅูุง ุฅุฐุง ุฐููุฑ ุบูุฑ ุฐูู
8. ุงููุนุงููุงุช ุงูููุณูุฉ ("ูููู"ุ "ูุงูุจุงูู") = ูุณูููุง ูุนุฏุฉ ูุนุงููุงุช

ุฃุฑุฌุน JSON ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู.`;

  return prompt;
}

/**
 * ุจูุงุก ูุต ุฌูุงุช ุงูุงุชุตุงู ููู prompt
 */
function buildContactsPrompt() {
  let text = '';
  for (const [code, contact] of Object.entries(CONTACTS)) {
    const custodyNote = contact.isCustody ? '(ุฃููู ุนูุฏุฉ - ุญุณุงุจ: ' + contact.account + ')' : '(ูุณุชููุฏ)';
    text += `- ${contact.name} ${custodyNote}: ${contact.aliases.slice(0, 3).join('ุ ')}\n`;
  }
  return text;
}

/**
 * โญ ุชุญููู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุจุงุณุชุฎุฏุงู Gemini
 */
function parseMessageWithGemini(userMessage, userName) {
  Logger.log('=== parseMessageWithGemini START ===');
  Logger.log('Message: ' + userMessage);
  Logger.log('User: ' + userName);

  try {
    var apiKey = CONFIG.GEMINI_API_KEY;

    if (!apiKey || apiKey.length < 10) {
      Logger.log('ERROR: Gemini API Key not configured');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ููุชุงุญ Gemini API ุบูุฑ ููุนุฏ. ุงุชุตู ุจุงููุณุคูู.',
        ุฑุณุงูุฉ: 'โ ููุชุงุญ Gemini API ุบูุฑ ููุนุฏ. ุงุชุตู ุจุงููุณุคูู.'
      };
    }

    var apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;
    var systemPrompt = buildAIPrompt();

    var prompt = systemPrompt + '\n\nุงูุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู "' + userName + '":\n"' + userMessage + '"\n\nุญูู ูุฐู ุงูุฑุณุงูุฉ ูุงุณุชุฎุฑุฌ ุงููุนุงููุงุช ุงููุงููุฉ. ุฃุฑุฌุน JSON ููุท.';

    var payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0.1,
        topK: 1,
        topP: 1,
        maxOutputTokens: 2048
      }
    };

    var options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    Logger.log('Calling Gemini API...');
    var response = UrlFetchApp.fetch(apiUrl, options);
    var responseCode = response.getResponseCode();
    Logger.log('Gemini Response Code: ' + responseCode);

    if (responseCode !== 200) {
      Logger.log('Gemini API Error: ' + response.getContentText());
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ุฎุทุฃ ูู Gemini API. ุญุงูู ูุฑุฉ ุฃุฎุฑู.',
        ุฑุณุงูุฉ: 'โ ุฎุทุฃ ูู Gemini API. ุญุงูู ูุฑุฉ ุฃุฎุฑู.'
      };
    }

    var result = JSON.parse(response.getContentText());

    if (!result.candidates || result.candidates.length === 0) {
      Logger.log('No candidates in response');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ. ุฌุฑุจ ุตูุงุบุฉ ูุฎุชููุฉ.',
        ุฑุณุงูุฉ: 'โ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ. ุฌุฑุจ ุตูุงุบุฉ ูุฎุชููุฉ.'
      };
    }

    var aiResponse = result.candidates[0].content.parts[0].text;
    Logger.log('AI Response: ' + aiResponse.substring(0, 500));

    // Extract JSON from response
    var jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      Logger.log('No JSON found in response');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ูู ุฃููู ุงูุฑุณุงูุฉ. ุฌุฑุจ:\nโข ุตุฑูุช 100 ุบุฏุงุก\nโข ุญููุช ูุณุงุฑุฉ 5000 ุนูุฏุฉ\nโข ูุฒู ุงูุฑุงุชุจ 8500',
        ุฑุณุงูุฉ: 'โ ูู ุฃููู ุงูุฑุณุงูุฉ. ุฌุฑุจ:\nโข ุตุฑูุช 100 ุบุฏุงุก\nโข ุญููุช ูุณุงุฑุฉ 5000 ุนูุฏุฉ\nโข ูุฒู ุงูุฑุงุชุจ 8500'
      };
    }

    var parsedData = JSON.parse(jsonMatch[0]);
    Logger.log('Parsed data: ' + JSON.stringify(parsedData));

    // ุชุญููู ุงูุจูุงูุงุช ููุชูุณูู ุงูููุญุฏ
    var normalizedData = normalizeAIResponse(parsedData);

    Logger.log('=== parseMessageWithGemini END ===');
    return normalizedData;

  } catch (error) {
    Logger.log('EXCEPTION in parseMessageWithGemini: ' + error.toString());
    Logger.log('Stack: ' + (error.stack || 'no stack'));
    return {
      success: false,
      ูุฌุงุญ: false,
      message: 'โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน:\n' + error.message + '\n\nุฌุฑุจ ูุฑุฉ ุฃุฎุฑู.',
      ุฑุณุงูุฉ: 'โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน:\n' + error.message + '\n\nุฌุฑุจ ูุฑุฉ ุฃุฎุฑู.'
    };
  }
}

/**
 * ุชุทุจูุน ุงุณุชุฌุงุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุชูุณูู ุงูููุญุฏ
 */
function normalizeAIResponse(data) {
  // ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุญููู
  const success = data.ูุฌุงุญ === true || data.success === true;

  if (!success) {
    return {
      success: false,
      ูุฌุงุญ: false,
      message: data.ุฑุณุงูุฉ || data.message || 'โ ูู ุฃููู ุงูุฑุณุงูุฉ',
      ุฑุณุงูุฉ: data.ุฑุณุงูุฉ || data.message || 'โ ูู ุฃููู ุงูุฑุณุงูุฉ',
      needsClarification: data.ูุญุชุงุฌ_ุชูุถูุญ || data.needsClarification || false,
      clarificationQuestion: data.ุณุคุงู_ุชูุถูุญู || data.clarificationQuestion || ''
    };
  }

  // ุชุญููู ุงููุนุงููุงุช
  const transactions = (data.ูุนุงููุงุช || data.transactions || []).map(t => ({
    nature: t.ุทุจูุนุฉ || t.nature || t.ููุน || t.type || '',
    category: t.ุชุตููู || t.category || '',
    item: t.ุจูุฏ || t.item || '',
    amount: parseFloat(t.ูุจูุบ || t.amount) || 0,
    currency: normalizeCurrency(t.ุนููุฉ || t.currency),
    fromAccount: t.ูู_ุญุณุงุจ || t.fromAccount || t.from_account || '',
    toAccount: t.ุฅูู_ุญุณุงุจ || t.toAccount || t.to_account || '',
    convertedAmount: parseFloat(t.ูุจูุบ_ูุญูู || t.ูุจูุบ_ูุณุชูู || t.convertedAmount || t.amount_received) || null,
    convertedCurrency: normalizeCurrency(t.ุนููุฉ_ูุญูู || t.ุนููุฉ_ูุณุชููุฉ || t.convertedCurrency || t.currency_received),
    exchangeRate: parseFloat(t.ุณุนุฑ_ุตุฑู || t.ุณุนุฑ_ุงูุตุฑู || t.exchangeRate || t.exchange_rate) || null,
    description: t.ูุตู || t.description || '',
    contact: t.ุฌูุฉ || t.contact || '',

    // ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู
    type: mapNatureToOldType(t.ุทุจูุนุฉ || t.nature || t.ููุน || t.type),
    amount_received: parseFloat(t.ูุจูุบ_ูุญูู || t.ูุจูุบ_ูุณุชูู || t.convertedAmount || t.amount_received) || null,
    currency_received: normalizeCurrency(t.ุนููุฉ_ูุญูู || t.ุนููุฉ_ูุณุชููุฉ || t.convertedCurrency || t.currency_received),
    exchange_rate: parseFloat(t.ุณุนุฑ_ุตุฑู || t.ุณุนุฑ_ุงูุตุฑู || t.exchangeRate || t.exchange_rate) || null
  }));

  return {
    success: true,
    ูุฌุงุญ: true,
    transactions: transactions,
    ูุนุงููุงุช: transactions,
    message: data.ุฑุณุงูุฉ || data.message || 'โ ุชู ููู ุงูุฑุณุงูุฉ',
    ุฑุณุงูุฉ: data.ุฑุณุงูุฉ || data.message || 'โ ุชู ููู ุงูุฑุณุงูุฉ',
    needsClarification: data.ูุญุชุงุฌ_ุชูุถูุญ || data.needsClarification || false,
    clarificationQuestion: data.ุณุคุงู_ุชูุถูุญู || data.clarificationQuestion || ''
  };
}

/**
 * ุชุทุจูุน ุงุณู ุงูุนููุฉ
 */
function normalizeCurrency(currency) {
  if (!currency) return 'ุฑูุงู';

  const map = {
    'sar': 'ุฑูุงู',
    'ุฑูุงู': 'ุฑูุงู',
    'ุณุนูุฏู': 'ุฑูุงู',
    'egp': 'ุฌููู',
    'ุฌููู': 'ุฌููู',
    'ูุตุฑู': 'ุฌููู',
    'usd': 'ุฏููุงุฑ',
    'ุฏููุงุฑ': 'ุฏููุงุฑ',
    'ุฃูุฑููู': 'ุฏููุงุฑ',
    'aed': 'ุฏุฑูู',
    'ุฏุฑูู': 'ุฏุฑูู',
    'ุฅูุงุฑุงุชู': 'ุฏุฑูู'
  };

  return map[currency.toLowerCase()] || currency;
}

/**
 * ุชุญููู ุงูุทุจูุนุฉ ููููุน ุงููุฏูู (ููุชูุงูู)
 */
function mapNatureToOldType(nature) {
  const map = {
    'ุฅูุฑุงุฏ': 'ุฏุฎู',
    'ูุตุฑูู': 'ูุตุฑูู',
    'ุชุญููู': 'ุชุญููู',
    'ุงุณุชุซูุงุฑ': 'ุฐูุจ'
  };
  return map[nature] || nature;
}

/**
 * โญ ุชุญููู ุงููุนุงููุงุช ูู ุชูุณูู AI ููุชูุณูู ุงูุฌุฏูุฏ
 */
function convertAITransactionToNew(aiTrans, user) {
  const transaction = {
    nature: aiTrans.nature || aiTrans.ุทุจูุนุฉ || '',
    category: aiTrans.category || aiTrans.ุชุตููู || '',
    item: aiTrans.item || aiTrans.ุจูุฏ || '',
    amount: aiTrans.amount || aiTrans.ูุจูุบ || 0,
    currency: aiTrans.currency || aiTrans.ุนููุฉ || 'ุฑูุงู',
    fromAccount: aiTrans.fromAccount || aiTrans.ูู_ุญุณุงุจ || '',
    toAccount: aiTrans.toAccount || aiTrans.ุฅูู_ุญุณุงุจ || '',
    convertedAmount: aiTrans.convertedAmount || aiTrans.ูุจูุบ_ูุญูู || '',
    convertedCurrency: aiTrans.convertedCurrency || aiTrans.ุนููุฉ_ูุญูู || '',
    exchangeRate: aiTrans.exchangeRate || aiTrans.ุณุนุฑ_ุตุฑู || '',
    description: aiTrans.description || aiTrans.ูุตู || ''
  };

  // ุชุญุฏูุฏ ุงูุญุณุงุจุงุช ุชููุงุฆูุงู ุฅุฐุง ูู ุชูุญุฏุฏ
  if (!transaction.fromAccount && !transaction.toAccount) {
    switch (transaction.nature) {
      case 'ุฅูุฑุงุฏ':
        transaction.toAccount = 'MAIN';
        break;
      case 'ูุตุฑูู':
        transaction.fromAccount = 'MAIN';
        break;
      case 'ุชุญููู':
        transaction.fromAccount = 'MAIN';
        // ูุญุงููุฉ ุชุญุฏูุฏ ุงูุญุณุงุจ ุงููุฌูุฉ ูู ุฌูุฉ ุงูุงุชุตุงู
        if (aiTrans.contact || aiTrans.ุฌูุฉ) {
          const contact = CONTACTS[aiTrans.contact || aiTrans.ุฌูุฉ];
          if (contact && contact.isCustody) {
            transaction.toAccount = contact.account;
          }
        }
        break;
    }
  }

  return transaction;
}

/**
 * ุชูููุฏ ุงุณุชุฌุงุจุฉ ุฐููุฉ ูุงุณุชูุณุงุฑุงุช ุงููุณุชุฎุฏู
 */
function generateSmartResponse(query, context) {
  try {
    const apiKey = CONFIG.GEMINI_API_KEY;
    const apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;

    const prompt = `ุฃูุช ูุณุงุนุฏ ูุญุงุณุจู ุฐูู. ุงููุณุชุฎุฏู ูุณุฃู ุนู ุจูุงูุงุชู ุงููุงููุฉ.

ุงูุจูุงูุงุช ุงููุชุงุญุฉ:
${JSON.stringify(context, null, 2)}

ุณุคุงู ุงููุณุชุฎุฏู: "${query}"

ุฃุฌุจ ุจุดูู ูุฎุชุตุฑ ููููุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.`;

    const payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0.3,
        maxOutputTokens: 1024
      }
    };

    const options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(apiUrl, options);
    const result = JSON.parse(response.getContentText());

    return result.candidates[0].content.parts[0].text;

  } catch (error) {
    Logger.log('Error in generateSmartResponse: ' + error.toString());
    return 'ุนุฐุฑุงูุ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุณุคุงู.';
  }
}

/**
 * ุชุตููู ุงูุญุฑูุฉ ุชููุงุฆูุงู
 */
function classifyTransaction(description, nature) {
  try {
    const apiKey = CONFIG.GEMINI_API_KEY;
    const apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;

    const items = getItemsByNature(nature);
    const itemsList = items.map(i => i.item).join('ุ ');

    const prompt = `ุตูู ูุฐู ุงูุญุฑูุฉ:
ุงููุตู: "${description}"
ุงูุทุจูุนุฉ: ${nature}

ุงูุจููุฏ ุงููุชุงุญุฉ: ${itemsList}

ุฃุฑุฌุน ุงุณู ุงูุจูุฏ ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู.`;

    const payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0,
        maxOutputTokens: 50
      }
    };

    const options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(apiUrl, options);
    const result = JSON.parse(response.getContentText());

    return result.candidates[0].content.parts[0].text.trim();

  } catch (error) {
    Logger.log('Error in classifyTransaction: ' + error.toString());
    return 'ุฃุฎุฑู';
  }
}

/**
 * ููุชูุงูู: ุชุตููู ุงูุชุตููู
 */
function classifyCategory(description, type) {
  const natureMap = {
    'ุฏุฎู': 'ุฅูุฑุงุฏ',
    'ูุตุฑูู': 'ูุตุฑูู',
    'ุชุญููู': 'ุชุญููู',
    'ุตุฑู_ูู_ุนูุฏุฉ': 'ูุตุฑูู',
    'ุฅูุฏุงุน_ุนูุฏุฉ': 'ุชุญููู'
  };

  return classifyTransaction(description, natureMap[type] || type);
}
