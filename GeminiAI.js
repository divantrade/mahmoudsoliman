/**
 * =====================================================
 * ูุธุงู ุงููุญุงุณุจุฉ ุงูุฐูู - Gemini AI Integration
 * ุงูุฅุตุฏุงุฑ 2.0 - ูุธุงู ุงูููุฏ ุงููุฒุฏูุฌ
 * =====================================================
 */

/**
 * โญ ุจูุงุก prompt ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุฏููุงููููุงู ูู ุงูุดูุชุงุช
 */
function buildAIPrompt() {
  // ูุฑุงุกุฉ ุงูุจููุฏ ูู ุงูุดูุช
  const itemsText = getItemsForAI();

  // ูุฑุงุกุฉ ุงูุญุณุงุจุงุช ูู ุงูุดูุช
  const accountsText = getAccountCodesForAI();

  // ูุฑุงุกุฉ ุงูุนููุงุช
  const currencies = getAllCurrencies();
  const currenciesText = currencies.map(c => `${c.name} (${c.code})`).join('ุ ');

  // ูุฑุงุกุฉ ุฌูุงุช ุงูุงุชุตุงู
  const contactsText = buildContactsPrompt();

  const prompt = `ุฃูุช ูุณุงุนุฏ ูุญุงุณุจู ุฐูู ููุธุงู ุงููุญุงุณุจุฉ ุงูุดุฎุตูุฉ.
ูููุชู ุชุญููู ุฑุณุงุฆู ุงููุณุชุฎุฏู ุจุงูุนุฑุจูุฉ ูุงุณุชุฎุฑุงุฌ ุงููุนูููุงุช ุงููุงููุฉ ูุชุญููููุง ูุญุฑูุงุช ูุญุงุณุจูุฉ.

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โญ ูุธุงู ุงูููุฏ ุงููุฒุฏูุฌ (ููู ุฌุฏุงู)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ูู ุญุฑูุฉ ูุงููุฉ ููุง ุทุฑูุงู:
- ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุตุฏุฑ (ุงูุฐู ูุฎุฑุฌ ููู ุงููุงู)
- ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุฌูุฉ (ุงูุฐู ูุฏุฎู ุฅููู ุงููุงู)

ุฃููุงุน ุงูุญุฑูุงุช:
1. ุฅูุฑุงุฏ: ุงููุงู ูุฏุฎู ูููุธุงู
   - ูู_ุญุณุงุจ: ูุงุฑุบ (ูุตุฏุฑ ุฎุงุฑุฌู)
   - ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุณุชูู (ุนุงุฏุฉ MAIN)

2. ูุตุฑูู: ุงููุงู ูุฎุฑุฌ ูู ุงููุธุงู
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงูุฐู ููุตุฑู ููู
   - ุฅูู_ุญุณุงุจ: ูุงุฑุบ (ูุตุฑูู ุฎุงุฑุฌู)

3. ุชุญููู: ุงููุงู ููุชูู ุฏุงุฎู ุงููุธุงู (ุจูู ุญุณุงุจูู)
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุตุฏุฑ
   - ุฅูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงููุฌูุฉ
   - ูุง ูุบูุฑ ุงููุฌููุน ุงูููู

4. ุงุณุชุซูุงุฑ: ุชุญููู ูุฃุตู (ุฐูุจ/ุฃุณูู)
   - ูู_ุญุณุงุจ: ุงูุญุณุงุจ ุงูุฐู ููุตุฑู ููู
   - ุฅูู_ุญุณุงุจ: ูุญูุธุฉ ุงูุฃุตู

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุญุณุงุจุงุช ุงููุชุงุญุฉ (ุงุณุชุฎุฏู ูุฐู ุงูุฃููุงุฏ ููุท!)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${accountsText}

ุฃููุงุน ุงูุญุณุงุจุงุช:
- ุฑุฆูุณู: ุงูุญุณุงุจ ุงูุดุฎุตู ุงูุฃุณุงุณู (MAIN)
- ุนูุฏุฉ: ุญุณุงุจ ุฃููู ุนูุฏุฉ (SARAุ MOSTAFAุ WIFEุ OM_CELIA)
- ูุณุชููุฏ: ุดุฎุต ููุณุงุนุฏ (ููุณ ูู ุฑุตูุฏ)
- ุงุฏุฎุงุฑ: ุฎุฒูุฉ ุงุฏุฎุงุฑ
- ุงุณุชุซูุงุฑ: ูุญูุธุฉ (ุฐูุจุ ุฃุณูู)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุจููุฏ ุงููุชุงุญุฉ (ุงุณุชุฎุฏู ูุฐู ุงูุจููุฏ ููุท! ูุง ุชุฎุชุฑุน ุจููุฏุงู ุฌุฏูุฏุฉ!)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${itemsText}

โ๏ธ ููู ุฌุฏุงู: ุงุณุชุฎุฏู ููุท ุงูุชุตูููุงุช ูุงูุจููุฏ ุงููุฐููุฑุฉ ุฃุนูุงู.
ูุง ุชุฎุชุฑุน ุชุตูููุงุช ุฃู ุจููุฏ ุฌุฏูุฏุฉ ูุซู "ูุตุฑููุงุช" - ุงุณุชุฎุฏู ุงูููุฌูุฏ ููุท!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฐ ุงูุนููุงุช ุงููุฏุนููุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${currenciesText}
- ุงูุงูุชุฑุงุถูุฉ: ุฑูุงู ุณุนูุฏู (SAR)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ฅ ุฌูุงุช ุงูุงุชุตุงู ูุญุณุงุจุงุชูู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
${contactsText}

โญ ุฑุจุท ุงูุฃุณูุงุก ุจุงูุญุณุงุจุงุช:
- ูุตุทูู / ูุตุทูู = MOSTAFA
- ูุฑุงุชู / ุฒูุฌุชู / ุงู ุณูููุง / ุงูุฒูุฌุฉ / WIFE = WIFE ุฃู OM_CELIA
- ุณุงุฑุฉ = SARA
- ูุงุฌุฑ = HAGAR
- ูุญูุฏ = MOHAMED

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โญโญโญ ูุงุนุฏุฉ ุฐูุจูุฉ: "ูู X ูู Y" โญโญโญ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุนูุฏูุง ูููู ุงููุณุชุฎุฏู "ูู ุดุฎุต ูุดุฎุต":
- "ูู ูุตุทูู ููุฑุงุชู 4000" = ุชุญููู ูู MOSTAFA ุฅูู WIFE
- "ูู ุณุงุฑุฉ ููุตุทูู 2000" = ุชุญููู ูู SARA ุฅูู MOSTAFA
- "ูู ุงูุนูุฏุฉ ููุฑุงุชู" = ุชุญููู ูู ุญุณุงุจ ุงูุนูุฏุฉ ุฅูู WIFE

โ๏ธ ููู: "ูู X ูู Y" ูุนูู ุงูุชุญููู ูู ุญุณุงุจ X ุฅูู ุญุณุงุจ Y
ูููุณ ูู MAIN! ุฅูุง ุฅุฐุง ูุงู "ูู ุญุณุงุจู" ุฃู "ูู ุนูุฏู"

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุฃูุซูุฉ ููุตูุฉ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

1. ุฏุฎู:
   "ูุฒู ุงูุฑุงุชุจ 8500"
   โ ุทุจูุนุฉ: ุฅูุฑุงุฏ, ุชุตููู: ุฑุงุชุจ, ุจูุฏ: ุฑุงุชุจ ุฃุณุงุณู
   โ ูุจูุบ: 8500, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: "", ุฅูู_ุญุณุงุจ: MAIN

2. ูุตุฑูู ูุจุงุดุฑ:
   "ุตุฑูุช 150 ุบุฏุงุก"
   โ ุทุจูุนุฉ: ูุตุฑูู, ุชุตููู: ูุนูุดุฉ, ุจูุฏ: ุทุนุงู ูุดุฑุงุจ
   โ ูุจูุบ: 150, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: MAIN, ุฅูู_ุญุณุงุจ: ""

3. ุชุญููู ูู MAIN ูุนูุฏุฉ:
   "ุญููุช ููุฑุงุชู 3000"
   โ ุทุจูุนุฉ: ุชุญููู, ุชุตููู: ุนูุฏุฉ, ุจูุฏ: ุชุญููู ูุนูุฏุฉ
   โ ูุจูุบ: 3000, ุนููุฉ: ุฑูุงู
   โ ูู_ุญุณุงุจ: MAIN, ุฅูู_ุญุณุงุจ: WIFE

4. โญ ุชุญููู ุจูู ุนูุฏุชูู (ูู X ูู Y):
   "ูู ูุตุทูู ููุฑุงุชู 4000 ุฌููู"
   โ ุทุจูุนุฉ: ุชุญููู, ุชุตููู: ุนูุฏุฉ, ุจูุฏ: ุชุญููู ุจูู ุนูุฏ
   โ ูุจูุบ: 4000, ุนููุฉ: ุฌููู
   โ ูู_ุญุณุงุจ: MOSTAFA, ุฅูู_ุญุณุงุจ: WIFE

5. โญ ุชุญููู ูู ุนูุฏุฉ ูุนูุฏุฉ ุฃุฎุฑู:
   "ูู ุณุงุฑุฉ ููุตุทูู 2000"
   โ ุทุจูุนุฉ: ุชุญููู, ุชุตููู: ุนูุฏุฉ, ุจูุฏ: ุชุญููู ุจูู ุนูุฏ
   โ ูุจูุบ: 2000, ุนููุฉ: ุฌููู
   โ ูู_ุญุณุงุจ: SARA, ุฅูู_ุญุณุงุจ: MOSTAFA

6. ุตุฑู ูู ุนูุฏุฉ:
   "ูุฑุงุชู ุตุฑูุช 1000 ุฌูุนูุฉ"
   โ ุทุจูุนุฉ: ูุตุฑูู, ุชุตููู: ุฌูุนูุฉ, ุจูุฏ: ูุณุท ุฌูุนูุฉ
   โ ูุจูุบ: 1000, ุนููุฉ: ุฌููู
   โ ูู_ุญุณุงุจ: WIFE, ุฅูู_ุญุณุงุจ: ""

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุงูุญุฑูุงุช ุงููุฑูุจุฉ (ุฑุณุงูุฉ ูุงุญุฏุฉ = ุนุฏุฉ ุญุฑูุงุช)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

ูุซุงู 1: "ูู ูุตุทูู ููุฑุงุชู 4000 ุฌููู ุชุงุฎุฏ ูููู 3000 ูุชุฏูุน ุฌูุนูุฉ 1000"

ุชููุณู ูู 3 ุญุฑูุงุช:
1. ุชุญููู 4000 ุฌููู ูู MOSTAFA โ WIFE
   โ ุทุจูุนุฉ: ุชุญููู, ูู_ุญุณุงุจ: MOSTAFA, ุฅูู_ุญุณุงุจ: WIFE

2. ูุตุฑูู 1000 ุฌููู (ุฌูุนูุฉ) ูู WIFE
   โ ุทุจูุนุฉ: ูุตุฑูู, ุชุตููู: ุฌูุนูุฉ, ุจูุฏ: ูุณุท ุฌูุนูุฉ
   โ ูู_ุญุณุงุจ: WIFE, ุฅูู_ุญุณุงุจ: ""

3. ูุตุฑูู 3000 ุฌููู (ูุตุฑููุงุช) ูู WIFE
   โ ุทุจูุนุฉ: ูุตุฑูู, ุชุตููู: ูุนูุดุฉ, ุจูุฏ: ูุตุฑููุงุช ููุฒููุฉ
   โ ูู_ุญุณุงุจ: WIFE, ุฅูู_ุญุณุงุจ: ""

ูุซุงู 2: "ุญููุช 5000 ูุณุงุฑุฉ ูููู 2000 ููุจูุช ู1000 ุฌูุนูุฉ ูุงูุจุงูู ูุนุงูุง"

ุชููุณู ูู 3 ุญุฑูุงุช:
1. ุชุญููู 5000 ูู MAIN โ SARA
2. ูุตุฑูู 2000 (ูุตุฑููุงุช ููุฒููุฉ) ูู SARA
3. ูุตุฑูู 1000 (ุฌูุนูุฉ) ูู SARA
(ุงูุจุงูู 2000 ูุจูู ูู ุนูุฏุฉ ุณุงุฑุฉ)

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
๐ ุชูุณูู ุงูุฅุฎุฑุงุฌ (JSON) - ูุซุงู ุญูููู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ูุซุงู: "ูู ูุตุทูู ููุฑุงุชู 4000 ุฌููู"
{
  "ูุฌุงุญ": true,
  "ูุนุงููุงุช": [
    {
      "ุทุจูุนุฉ": "ุชุญููู",
      "ุชุตููู": "ุนูุฏุฉ",
      "ุจูุฏ": "ุชุญููู ุจูู ุนูุฏ",
      "ูุจูุบ": 4000,
      "ุนููุฉ": "ุฌููู",
      "ูู_ุญุณุงุจ": "MOSTAFA",
      "ุฅูู_ุญุณุงุจ": "WIFE",
      "ูุตู": "ุชุญููู ูู ุนูุฏุฉ ูุตุทูู ูุนูุฏุฉ ุงูุฒูุฌุฉ"
    }
  ],
  "ุฑุณุงูุฉ": "ุชุญููู 4000 ุฌููู ูู ูุตุทูู ููุฒูุฌุฉ"
}

โ๏ธโ๏ธโ๏ธ ููู ุฌุฏุงู: ูุฌุจ ููุก "ูู_ุญุณุงุจ" ู "ุฅูู_ุญุณุงุจ" ุจุฃููุงุฏ ุงูุญุณุงุจุงุช ุงููุนููุฉ!
- "ูู ูุตุทูู" = ูู_ุญุณุงุจ: "MOSTAFA"
- "ููุฑุงุชู" = ุฅูู_ุญุณุงุจ: "WIFE"
- ูุง ุชุชุฑู ูุฐู ุงูุญููู ูุงุฑุบุฉ ูู ุงูุชุญูููุงุช!

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ๏ธ ููุงุนุฏ ูููุฉ ุฌุฏุงู
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
1. โญ "ูู X ูู Y" = ุชุญููู ูู ุญุณุงุจ X ุฅูู ุญุณุงุจ Y (ูููุณ ูู MAIN!)
2. ูุฑุงุชู/ุฒูุฌุชู/WIFE = ุญุณุงุจ WIFE
3. ุงุณุชุฎุฏู ููุท ุงูุชุตูููุงุช ูุงูุจููุฏ ุงููุฐููุฑุฉ ูู ุงููุงุฆูุฉ ุฃุนูุงู
4. ูุง ุชุฎุชุฑุน ุชุตูููุงุช ุฌุฏูุฏุฉ - ุงุณุชุฎุฏู ุงูุฃูุฑุจ ูู ุงูููุฌูุฏ
5. ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ = ุฑูุงูุ ุฅูุง ุฅุฐุง ุฐููุฑ "ุฌููู" ุฃู "ุฏููุงุฑ"
6. ุงูุญุณุงุจ ุงูุงูุชุฑุงุถู = MAIN ููุท ุฅุฐุง ูู ููุฐูุฑ ุญุณุงุจ ุขุฎุฑ
7. "ูููู" ุฃู "ูุงูุจุงูู" = ูุณูู ูุนุฏุฉ ุญุฑูุงุช
8. ุตุฑู ูู ุนูุฏุฉ = ูู_ุญุณุงุจ = ููุฏ ุงูุนูุฏุฉ

ุฃุฑุฌุน JSON ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู.`;

  return prompt;
}

/**
 * ุจูุงุก ูุต ุฌูุงุช ุงูุงุชุตุงู ููู prompt
 */
function buildContactsPrompt() {
  let text = '';
  for (const [code, contact] of Object.entries(CONTACTS)) {
    const custodyNote = contact.isCustody ? '(ุฃููู ุนูุฏุฉ - ุญุณุงุจ: ' + contact.account + ')' : '(ูุณุชููุฏ)';
    text += `- ${contact.name} ${custodyNote}: ${contact.aliases.slice(0, 3).join('ุ ')}\n`;
  }
  return text;
}

/**
 * โญ ุชุญููู ุฑุณุงูุฉ ุงููุณุชุฎุฏู ุจุงุณุชุฎุฏุงู Gemini
 */
function parseMessageWithGemini(userMessage, userName) {
  Logger.log('=== parseMessageWithGemini START ===');
  Logger.log('Message: ' + userMessage);
  Logger.log('User: ' + userName);

  try {
    var apiKey = CONFIG.GEMINI_API_KEY;

    if (!apiKey || apiKey.length < 10) {
      Logger.log('ERROR: Gemini API Key not configured');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ููุชุงุญ Gemini API ุบูุฑ ููุนุฏ. ุงุชุตู ุจุงููุณุคูู.',
        ุฑุณุงูุฉ: 'โ ููุชุงุญ Gemini API ุบูุฑ ููุนุฏ. ุงุชุตู ุจุงููุณุคูู.'
      };
    }

    var apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;
    var systemPrompt = buildAIPrompt();

    var prompt = systemPrompt + '\n\nุงูุฑุณุงูุฉ ูู ุงููุณุชุฎุฏู "' + userName + '":\n"' + userMessage + '"\n\nุญูู ูุฐู ุงูุฑุณุงูุฉ ูุงุณุชุฎุฑุฌ ุงููุนุงููุงุช ุงููุงููุฉ. ุฃุฑุฌุน JSON ููุท.';

    var payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0.1,
        topK: 1,
        topP: 1,
        maxOutputTokens: 2048
      }
    };

    var options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    Logger.log('Calling Gemini API...');
    var response = UrlFetchApp.fetch(apiUrl, options);
    var responseCode = response.getResponseCode();
    Logger.log('Gemini Response Code: ' + responseCode);

    if (responseCode !== 200) {
      Logger.log('Gemini API Error: ' + response.getContentText());
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ุฎุทุฃ ูู Gemini API. ุญุงูู ูุฑุฉ ุฃุฎุฑู.',
        ุฑุณุงูุฉ: 'โ ุฎุทุฃ ูู Gemini API. ุญุงูู ูุฑุฉ ุฃุฎุฑู.'
      };
    }

    var result = JSON.parse(response.getContentText());

    if (!result.candidates || result.candidates.length === 0) {
      Logger.log('No candidates in response');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ. ุฌุฑุจ ุตูุงุบุฉ ูุฎุชููุฉ.',
        ุฑุณุงูุฉ: 'โ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุฑุณุงูุฉ. ุฌุฑุจ ุตูุงุบุฉ ูุฎุชููุฉ.'
      };
    }

    var aiResponse = result.candidates[0].content.parts[0].text;
    Logger.log('AI Response: ' + aiResponse.substring(0, 500));

    // Extract JSON from response
    var jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
    if (!jsonMatch) {
      Logger.log('No JSON found in response');
      return {
        success: false,
        ูุฌุงุญ: false,
        message: 'โ ูู ุฃููู ุงูุฑุณุงูุฉ. ุฌุฑุจ:\nโข ุตุฑูุช 100 ุบุฏุงุก\nโข ุญููุช ูุณุงุฑุฉ 5000 ุนูุฏุฉ\nโข ูุฒู ุงูุฑุงุชุจ 8500',
        ุฑุณุงูุฉ: 'โ ูู ุฃููู ุงูุฑุณุงูุฉ. ุฌุฑุจ:\nโข ุตุฑูุช 100 ุบุฏุงุก\nโข ุญููุช ูุณุงุฑุฉ 5000 ุนูุฏุฉ\nโข ูุฒู ุงูุฑุงุชุจ 8500'
      };
    }

    var parsedData = JSON.parse(jsonMatch[0]);
    Logger.log('Parsed data: ' + JSON.stringify(parsedData));

    // ุชุญููู ุงูุจูุงูุงุช ููุชูุณูู ุงูููุญุฏ
    var normalizedData = normalizeAIResponse(parsedData);

    Logger.log('=== parseMessageWithGemini END ===');
    return normalizedData;

  } catch (error) {
    Logger.log('EXCEPTION in parseMessageWithGemini: ' + error.toString());
    Logger.log('Stack: ' + (error.stack || 'no stack'));
    return {
      success: false,
      ูุฌุงุญ: false,
      message: 'โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน:\n' + error.message + '\n\nุฌุฑุจ ูุฑุฉ ุฃุฎุฑู.',
      ุฑุณุงูุฉ: 'โ ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน:\n' + error.message + '\n\nุฌุฑุจ ูุฑุฉ ุฃุฎุฑู.'
    };
  }
}

/**
 * ุชุทุจูุน ุงุณุชุฌุงุจุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู ููุชูุณูู ุงูููุญุฏ
 */
function normalizeAIResponse(data) {
  // ุงูุชุญูู ูู ูุฌุงุญ ุงูุชุญููู
  const success = data.ูุฌุงุญ === true || data.success === true;

  if (!success) {
    return {
      success: false,
      ูุฌุงุญ: false,
      message: data.ุฑุณุงูุฉ || data.message || 'โ ูู ุฃููู ุงูุฑุณุงูุฉ',
      ุฑุณุงูุฉ: data.ุฑุณุงูุฉ || data.message || 'โ ูู ุฃููู ุงูุฑุณุงูุฉ',
      needsClarification: data.ูุญุชุงุฌ_ุชูุถูุญ || data.needsClarification || false,
      clarificationQuestion: data.ุณุคุงู_ุชูุถูุญู || data.clarificationQuestion || ''
    };
  }

  // ุชุญููู ุงููุนุงููุงุช
  const transactions = (data.ูุนุงููุงุช || data.transactions || []).map(t => {
    var trans = {
      nature: t.ุทุจูุนุฉ || t.nature || t.ููุน || t.type || '',
      category: t.ุชุตููู || t.category || '',
      item: t.ุจูุฏ || t.item || '',
      amount: parseFloat(t.ูุจูุบ || t.amount) || 0,
      currency: normalizeCurrency(t.ุนููุฉ || t.currency),
      fromAccount: t.ูู_ุญุณุงุจ || t.fromAccount || t.from_account || '',
      toAccount: t.ุฅูู_ุญุณุงุจ || t.toAccount || t.to_account || '',
      convertedAmount: parseFloat(t.ูุจูุบ_ูุญูู || t.ูุจูุบ_ูุณุชูู || t.convertedAmount || t.amount_received) || null,
      convertedCurrency: normalizeCurrency(t.ุนููุฉ_ูุญูู || t.ุนููุฉ_ูุณุชููุฉ || t.convertedCurrency || t.currency_received),
      exchangeRate: parseFloat(t.ุณุนุฑ_ุตุฑู || t.ุณุนุฑ_ุงูุตุฑู || t.exchangeRate || t.exchange_rate) || null,
      description: t.ูุตู || t.description || '',
      contact: t.ุฌูุฉ || t.contact || '',

      // ููุชูุงูู ูุน ุงููุธุงู ุงููุฏูู
      type: mapNatureToOldType(t.ุทุจูุนุฉ || t.nature || t.ููุน || t.type),
      amount_received: parseFloat(t.ูุจูุบ_ูุญูู || t.ูุจูุบ_ูุณุชูู || t.convertedAmount || t.amount_received) || null,
      currency_received: normalizeCurrency(t.ุนููุฉ_ูุญูู || t.ุนููุฉ_ูุณุชููุฉ || t.convertedCurrency || t.currency_received),
      exchange_rate: parseFloat(t.ุณุนุฑ_ุตุฑู || t.ุณุนุฑ_ุงูุตุฑู || t.exchangeRate || t.exchange_rate) || null
    };

    // โญโญโญ ุงุณุชุฎุฑุงุฌ ุงูุญุณุงุจุงุช ูู ุงููุตู ุฅุฐุง ูุงูุช ูุงุฑุบุฉ โญโญโญ
    if ((trans.nature === 'ุชุญููู' || trans.type === 'ุชุญููู') && (!trans.fromAccount || !trans.toAccount)) {
      var extracted = extractAccountsFromDescription(trans.description);
      if (extracted.fromAccount && !trans.fromAccount) {
        trans.fromAccount = extracted.fromAccount;
        trans.from_account = extracted.fromAccount;
      }
      if (extracted.toAccount && !trans.toAccount) {
        trans.toAccount = extracted.toAccount;
        trans.to_account = extracted.toAccount;
      }
    }

    return trans;
  });

  return {
    success: true,
    ูุฌุงุญ: true,
    transactions: transactions,
    ูุนุงููุงุช: transactions,
    message: data.ุฑุณุงูุฉ || data.message || 'โ ุชู ููู ุงูุฑุณุงูุฉ',
    ุฑุณุงูุฉ: data.ุฑุณุงูุฉ || data.message || 'โ ุชู ููู ุงูุฑุณุงูุฉ',
    needsClarification: data.ูุญุชุงุฌ_ุชูุถูุญ || data.needsClarification || false,
    clarificationQuestion: data.ุณุคุงู_ุชูุถูุญู || data.clarificationQuestion || ''
  };
}

/**
 * โญ ุงุณุชุฎุฑุงุฌ ุงูุญุณุงุจุงุช ูู ูุตู ุงูุญุฑูุฉ
 */
function extractAccountsFromDescription(description) {
  var result = { fromAccount: '', toAccount: '' };
  if (!description) return result;

  // ูุงููุณ ุงูุฃุณูุงุก ูุงูุญุณุงุจุงุช
  var nameToAccount = {
    'ูุตุทูู': 'MOSTAFA', 'ูุตุทูู': 'MOSTAFA',
    'ุณุงุฑุฉ': 'SARA', 'ุณุงุฑู': 'SARA',
    'ุงูุฒูุฌุฉ': 'WIFE', 'ุงูุฒูุฌู': 'WIFE', 'ูุฑุงุชู': 'WIFE', 'ุฒูุฌุชู': 'WIFE',
    'ุงู ุณูููุง': 'WIFE', 'ุฃู ุณูููุง': 'WIFE',
    'ูุงุฌุฑ': 'HAGAR', 'ูุญูุฏ': 'MOHAMED',
    'ุญุณุงุจู': 'MAIN', 'ุงูุฑุฆูุณู': 'MAIN', 'ุงูุฎุฒูุฉ': 'MAIN'
  };

  // ุงูุจุญุซ ุนู "ูู X"
  var fromMatch = description.match(/ูู ุนูุฏุฉ? ([^\s]+)|ูู ([^\s]+) ู/);
  if (fromMatch) {
    var name = (fromMatch[1] || fromMatch[2] || '').replace(/ุฉ$/, 'ู');
    for (var key in nameToAccount) {
      if (name.indexOf(key) !== -1 || key.indexOf(name) !== -1) {
        result.fromAccount = nameToAccount[key];
        break;
      }
    }
  }

  // ุงูุจุญุซ ุนู "ูู Y"
  var toMatch = description.match(/ูุนูุฏุฉ? ([^\s]+)|ู([^\s]+)$/);
  if (toMatch) {
    var name2 = (toMatch[1] || toMatch[2] || '').replace(/ุฉ$/, 'ู');
    for (var key2 in nameToAccount) {
      if (name2.indexOf(key2) !== -1 || key2.indexOf(name2) !== -1) {
        result.toAccount = nameToAccount[key2];
        break;
      }
    }
  }

  Logger.log('Extracted: from=' + result.fromAccount + ', to=' + result.toAccount);
  return result;
}

/**
 * ุชุทุจูุน ุงุณู ุงูุนููุฉ
 */
function normalizeCurrency(currency) {
  if (!currency) return 'ุฑูุงู';

  const map = {
    'sar': 'ุฑูุงู',
    'ุฑูุงู': 'ุฑูุงู',
    'ุณุนูุฏู': 'ุฑูุงู',
    'egp': 'ุฌููู',
    'ุฌููู': 'ุฌููู',
    'ูุตุฑู': 'ุฌููู',
    'usd': 'ุฏููุงุฑ',
    'ุฏููุงุฑ': 'ุฏููุงุฑ',
    'ุฃูุฑููู': 'ุฏููุงุฑ',
    'aed': 'ุฏุฑูู',
    'ุฏุฑูู': 'ุฏุฑูู',
    'ุฅูุงุฑุงุชู': 'ุฏุฑูู'
  };

  return map[currency.toLowerCase()] || currency;
}

/**
 * ุชุญููู ุงูุทุจูุนุฉ ููููุน ุงููุฏูู (ููุชูุงูู)
 */
function mapNatureToOldType(nature) {
  const map = {
    'ุฅูุฑุงุฏ': 'ุฏุฎู',
    'ูุตุฑูู': 'ูุตุฑูู',
    'ุชุญููู': 'ุชุญููู',
    'ุงุณุชุซูุงุฑ': 'ุฐูุจ'
  };
  return map[nature] || nature;
}

/**
 * โญ ุชุญููู ุงููุนุงููุงุช ูู ุชูุณูู AI ููุชูุณูู ุงูุฌุฏูุฏ
 */
function convertAITransactionToNew(aiTrans, user) {
  const transaction = {
    nature: aiTrans.nature || aiTrans.ุทุจูุนุฉ || '',
    category: aiTrans.category || aiTrans.ุชุตููู || '',
    item: aiTrans.item || aiTrans.ุจูุฏ || '',
    amount: aiTrans.amount || aiTrans.ูุจูุบ || 0,
    currency: aiTrans.currency || aiTrans.ุนููุฉ || 'ุฑูุงู',
    fromAccount: aiTrans.fromAccount || aiTrans.ูู_ุญุณุงุจ || '',
    toAccount: aiTrans.toAccount || aiTrans.ุฅูู_ุญุณุงุจ || '',
    convertedAmount: aiTrans.convertedAmount || aiTrans.ูุจูุบ_ูุญูู || '',
    convertedCurrency: aiTrans.convertedCurrency || aiTrans.ุนููุฉ_ูุญูู || '',
    exchangeRate: aiTrans.exchangeRate || aiTrans.ุณุนุฑ_ุตุฑู || '',
    description: aiTrans.description || aiTrans.ูุตู || ''
  };

  // ุชุญุฏูุฏ ุงูุญุณุงุจุงุช ุชููุงุฆูุงู ุฅุฐุง ูู ุชูุญุฏุฏ
  if (!transaction.fromAccount && !transaction.toAccount) {
    switch (transaction.nature) {
      case 'ุฅูุฑุงุฏ':
        transaction.toAccount = 'MAIN';
        break;
      case 'ูุตุฑูู':
        transaction.fromAccount = 'MAIN';
        break;
      case 'ุชุญููู':
        transaction.fromAccount = 'MAIN';
        // ูุญุงููุฉ ุชุญุฏูุฏ ุงูุญุณุงุจ ุงููุฌูุฉ ูู ุฌูุฉ ุงูุงุชุตุงู
        if (aiTrans.contact || aiTrans.ุฌูุฉ) {
          const contact = CONTACTS[aiTrans.contact || aiTrans.ุฌูุฉ];
          if (contact && contact.isCustody) {
            transaction.toAccount = contact.account;
          }
        }
        break;
    }
  }

  return transaction;
}

/**
 * ุชูููุฏ ุงุณุชุฌุงุจุฉ ุฐููุฉ ูุงุณุชูุณุงุฑุงุช ุงููุณุชุฎุฏู
 */
function generateSmartResponse(query, context) {
  try {
    const apiKey = CONFIG.GEMINI_API_KEY;
    const apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;

    const prompt = `ุฃูุช ูุณุงุนุฏ ูุญุงุณุจู ุฐูู. ุงููุณุชุฎุฏู ูุณุฃู ุนู ุจูุงูุงุชู ุงููุงููุฉ.

ุงูุจูุงูุงุช ุงููุชุงุญุฉ:
${JSON.stringify(context, null, 2)}

ุณุคุงู ุงููุณุชุฎุฏู: "${query}"

ุฃุฌุจ ุจุดูู ูุฎุชุตุฑ ููููุฏ ุจุงููุบุฉ ุงูุนุฑุจูุฉ.`;

    const payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0.3,
        maxOutputTokens: 1024
      }
    };

    const options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(apiUrl, options);
    const result = JSON.parse(response.getContentText());

    return result.candidates[0].content.parts[0].text;

  } catch (error) {
    Logger.log('Error in generateSmartResponse: ' + error.toString());
    return 'ุนุฐุฑุงูุ ูู ุฃุณุชุทุน ูุนุงูุฌุฉ ุงูุณุคุงู.';
  }
}

/**
 * ุชุตููู ุงูุญุฑูุฉ ุชููุงุฆูุงู
 */
function classifyTransaction(description, nature) {
  try {
    const apiKey = CONFIG.GEMINI_API_KEY;
    const apiUrl = CONFIG.GEMINI_API_URL + '?key=' + apiKey;

    const items = getItemsByNature(nature);
    const itemsList = items.map(i => i.item).join('ุ ');

    const prompt = `ุตูู ูุฐู ุงูุญุฑูุฉ:
ุงููุตู: "${description}"
ุงูุทุจูุนุฉ: ${nature}

ุงูุจููุฏ ุงููุชุงุญุฉ: ${itemsList}

ุฃุฑุฌุน ุงุณู ุงูุจูุฏ ููุท ุจุฏูู ุฃู ูุต ุฅุถุงูู.`;

    const payload = {
      contents: [{
        parts: [{
          text: prompt
        }]
      }],
      generationConfig: {
        temperature: 0,
        maxOutputTokens: 50
      }
    };

    const options = {
      method: 'POST',
      contentType: 'application/json',
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };

    const response = UrlFetchApp.fetch(apiUrl, options);
    const result = JSON.parse(response.getContentText());

    return result.candidates[0].content.parts[0].text.trim();

  } catch (error) {
    Logger.log('Error in classifyTransaction: ' + error.toString());
    return 'ุฃุฎุฑู';
  }
}

/**
 * ููุชูุงูู: ุชุตููู ุงูุชุตููู
 */
function classifyCategory(description, type) {
  const natureMap = {
    'ุฏุฎู': 'ุฅูุฑุงุฏ',
    'ูุตุฑูู': 'ูุตุฑูู',
    'ุชุญููู': 'ุชุญููู',
    'ุตุฑู_ูู_ุนูุฏุฉ': 'ูุตุฑูู',
    'ุฅูุฏุงุน_ุนูุฏุฉ': 'ุชุญููู'
  };

  return classifyTransaction(description, natureMap[type] || type);
}
